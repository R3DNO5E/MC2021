# Linuxシステムプログラミング入門 事前学習#4 演習：ファイルを実行してその結果を取得する関数
## 概要
ここでは，演習環境の操作方法とLinuxの基本概念の理解度の確認のため，以下のような関数を実装します．
* 実行ファイルの相対パスまたは絶対パスを受け取る
* そのファイルを実行し，終了後に標準出力の内容をC文字列として返す

## 仕様
### プロトタイプ
```
int execute_binary(const char* const binary, char* const buffer, const size_t bufsize);
```

### 返り値
実行に成功した場合，実行したプログラムの標準出力から読み取った文字のバイト数．失敗した場合は`-1`．

### 引数

|名前|型|意味|
|---|---|---|
|`binary`|`const char* const`|実行するバイナリファイルのパスの文字列|
|`buffer`|`char* const`|実行結果を書き込むためのバッファ|
|`bufsize`|`const size_t`|実行結果を書き込むためのバッファの大きさ|

### 挙動
与えられたバイナリファイルを実行する．実行するとき標準入力と標準エラー出力は使用しない．標準出力の内容を`buffer`の指すメモリに書き込む．出力の長さが`bufsize`を越えるときは越えない分のみをメモリに書き込み，残りは無視する．実行するファイルのパスの長さには制限があってもよい．

## 想定する使い方
以下のようなCコードで，`buf`の指すメモリに`/bin/ls`を実行した結果の文字列が書き込まれ，それを`printf`で出力しています．
```
#define OUTPUT_BUFFER_SIZE 1024

int main(){
	char buf[OUTPUT_BUFFER_SIZE] = {0};
	int r = execute_binary("/bin/ls", buf, OUTPUT_BUFFER_SIZE);
	buf[r] = '\0';
	if(r >= 0){
		printf("read %d bytes\n%s\n", r, buf);
	} else {
		printf("error %d\n", r);
	}
}
```

## ヒント
### 方針
#### execveを使う
外部のプログラムを実行するには`execve`システムコールを使えばよさそうです．しかし，このシステムコールは呼び出したプロセスを実行したファイルのものに置き換えてしまうため，このままでは実行結果の文字列を取得できません．
#### cloneを使う
`clone`システムコールを使うと，プロセスを新しく作成することができます．新しく作成したプロセスで`execve`を呼ぶことによって，それまで実行していたプログラムの内容はそのままにファイルを実行することができます．
#### パイプを使う
`clone`システムコールで作成した新しいプロセスからそれまで実行していたプロセスに，標準出力の内容をコピーしてくる必要があります．パイプを利用して，標準出力の内容を取得します．`dup2`システムコールを使うと，プログラムが標準出力に書き込んだ内容をパイプで取得することができます．パイプの作成には`pipe`システムコールを使います．
### 注意点
以下は陥りがちな失敗を避けるための注意点です．
* readは読み取り可能になるまで実行をブロックします
* 子プロセスが終了するまで待ち合わせる必要があります
* パイプは片方向です
* スタックサイズには制限があります

## 提出
* 作成したCソースファイル
* CMakeLists.txt
* その他ビルドシステムの生成したファイル

上記のものを含むディレクトリをtarまたはzip形式で圧縮して，以下のフォームから提出してください．tar形式への圧縮は以下のコマンドでできます．
```
$ tar cvf [圧縮ファイルのファイル名] [圧縮するディレクトリ名]
```
たとえば，`pretask1`というディレクトリを`submit.tar`というファイルに圧縮したい時は以下のようになります．
```
$ tar cvf submit.tar pretask1
```
フォームの閲覧にはセキュリティキャンプから提供されたGoogleアカウントへログインしている必要があります．
[提出フォーム](https://forms.gle/U8FDNm5NVJywi5FZ7)
## 質問など
表記が不明瞭な場合，調べ方や進め方が分からない場合や，エラーが発生して自力解決が困難な場合は，kintoneやDiscordで気軽に質問してください．不備を見つけた場合も同様にお願いします．
